name: Staging Auto-Cleanup

on:
  schedule:
    # Run every 4 hours
    - cron: '0 */4 * * *'
  workflow_dispatch:
    inputs:
      force_cleanup:
        description: 'Force cleanup regardless of activity'
        required: false
        type: boolean
        default: false

jobs:
  check-and-cleanup:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Check staging activity and cleanup if idle
        uses: appleboy/ssh-action@v1.0.3
        id: cleanup
        continue-on-error: true
        timeout-minutes: 8
        env:
          FORCE_CLEANUP: ${{ github.event.inputs.force_cleanup }}
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: deploy
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          command_timeout: 8m
          envs: FORCE_CLEANUP
          script: |
            cd "$HOME/watch-party" || exit 0
            
            ACTIVITY_LOG="logs/staging-activity.log"
            NGINX_LOG="/var/log/nginx/staging-access.log"
            INACTIVITY_THRESHOLD=86400  # 24 hours in seconds
            
            # Create activity log if it doesn't exist
            mkdir -p logs
            touch "$ACTIVITY_LOG"
            
            # Check if staging is running
            STAGING_RUNNING=$(docker ps --filter "name=.*staging" --format "{{.Names}}" 2>/dev/null | wc -l || echo "0")
            
            if [ "$STAGING_RUNNING" -eq 0 ]; then
              echo "âœ… Staging is already stopped. No cleanup needed."
              exit 0
            fi
            
            echo "ðŸ” Staging is running. Checking for activity..."
            
            # Force cleanup if requested
            if [ "$FORCE_CLEANUP" = "true" ]; then
              echo "âš ï¸ Force cleanup requested. Stopping staging environment..."
              docker-compose -f docker-compose.staging.yml down 2>/dev/null || docker compose -f docker-compose.staging.yml down 2>/dev/null || true
              echo "$(date -Iseconds) - Force cleanup by GitHub Actions" >> "$ACTIVITY_LOG"
              exit 0
            fi
            
            # Check Nginx access logs for staging domain activity
            LAST_ACCESS_TIME=0
            if [ -f "$NGINX_LOG" ] && sudo test -r "$NGINX_LOG" 2>/dev/null; then
              # Get timestamp of last staging request
              LAST_ACCESS=$(sudo grep "staging-watch-party.brahim-elhouss.me\|staging-be-watch-party.brahim-elhouss.me" "$NGINX_LOG" 2>/dev/null | tail -1 | awk '{print $4}' | tr -d '[' || echo "")
              
              if [ -n "$LAST_ACCESS" ]; then
                # Convert to epoch timestamp
                LAST_ACCESS_TIME=$(date -d "${LAST_ACCESS}" +%s 2>/dev/null || echo "0")
              fi
            fi
            
            # Check activity log for deployment activity
            if [ -f "$ACTIVITY_LOG" ]; then
              LAST_DEPLOY=$(tail -1 "$ACTIVITY_LOG" 2>/dev/null | awk '{print $1}' || echo "")
              if [ -n "$LAST_DEPLOY" ]; then
                LAST_DEPLOY_TIME=$(date -d "${LAST_DEPLOY}" +%s 2>/dev/null || echo "0")
                if [ "$LAST_DEPLOY_TIME" -gt "$LAST_ACCESS_TIME" ] 2>/dev/null; then
                  LAST_ACCESS_TIME=$LAST_DEPLOY_TIME
                fi
              fi
            fi
            
            # Current time
            CURRENT_TIME=$(date +%s)
            
            # Calculate inactivity duration
            if [ "$LAST_ACCESS_TIME" -eq 0 ] 2>/dev/null; then
              # No activity recorded, check container uptime
              STAGING_CONTAINER=$(docker ps -q --filter "name=.*staging" 2>/dev/null | head -1)
              if [ -n "$STAGING_CONTAINER" ]; then
                CONTAINER_UPTIME=$(docker inspect -f '{{.State.StartedAt}}' "$STAGING_CONTAINER" 2>/dev/null || echo "")
                if [ -n "$CONTAINER_UPTIME" ]; then
                  LAST_ACCESS_TIME=$(date -d "${CONTAINER_UPTIME}" +%s 2>/dev/null || echo "0")
                fi
              fi
            fi
            
            INACTIVE_SECONDS=$((CURRENT_TIME - LAST_ACCESS_TIME))
            INACTIVE_HOURS=$((INACTIVE_SECONDS / 3600))
            
            echo "Last activity: $(date -d @${LAST_ACCESS_TIME} 2>/dev/null || echo 'Unknown')"
            echo "Inactive for: ${INACTIVE_HOURS} hours (${INACTIVE_SECONDS} seconds)"
            echo "Threshold: 24 hours (${INACTIVITY_THRESHOLD} seconds)"
            
            if [ "$INACTIVE_SECONDS" -ge "$INACTIVITY_THRESHOLD" ]; then
              echo "âš ï¸ Staging inactive for ${INACTIVE_HOURS} hours. Stopping services..."
              docker-compose -f docker-compose.staging.yml down 2>/dev/null || docker compose -f docker-compose.staging.yml down 2>/dev/null || true
              echo "$(date -Iseconds) - Auto-cleanup after ${INACTIVE_HOURS}h inactivity" >> "$ACTIVITY_LOG"
            else
              echo "âœ… Staging is active. No cleanup needed."
            fi
